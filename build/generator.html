<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Query generator</title>
    <script src="tables.js"></script>
<style>
body{font-family:Arial,sans-serif;font-size:11pt}.rc-prev{color:#ccc}.rc-past{color:#666}.rc-new{font-weight:700}.sql-keyword{color:#620;font-weight:700}.sql-star{color:#f50}.sql-column{color:#a01}.sql-text{color:#250}.sql-number{color:#30f}#page{display:flex;height:100vh}#side{flex-shrink:0;height:100vh;min-width:470px;overflow-y:auto;padding:8px}#result{flex-grow:1;padding:20px}#query{border:1px solid #333;background-color:#eee;display:inline-block;padding:20px;font-family:Consolas,monospace}#query:empty,#query_debug:empty{display:none}#query_debug{font-family:Consolas,monospace;margin-top:1em}#tables{margin-bottom:1em}#version{float:right;font-size:.8em;color:#ac8}.clicky{cursor:pointer}.active-column{font-weight:700}.btn-active{background-color:#ff4}.btn-table{background-color:transparent;color:#111;font-weight:700;padding:2px;border:0;font-size:10.5pt}.btn-table:hover{background-color:#ff7}ul.table-list{list-style:none;padding:5px}.rc-source{font-weight:700}li.separator{margin-top:4px;border-top:1px dashed #ccc;padding-top:2px}button.filter-has-entries{color:#c70}.copy-hint{opacity:0;transition:opacity .8s ease;color:#999;font-size:.9em;margin-left:.5em}.copy-hint.show{opacity:1}
</style>
    <link rel="stylesheet" href="custom.css"/>
</head>
<body>

<div id="version"></div>
<div id="page">
    <div id="side">
        <div id="tables"></div>
        <button id="btn_reset">Reset</button>
        <button id="btn_agg" style="display: none">Aggregate</button>
    </div>
    <div id="result">
        <pre id="query"></pre>
        <br><button id="btn_copy">Copy</button> <span class="copy-hint" id="copied_hint">Copied!</span>
        <div id="query_debug"></div>
    </div>
</div>

<script>
"use strict";var QB;!function(e){e.AggregateButton=class{constructor(e){this.buttonElement=e}hide(){this.buttonElement.style.display="none",this.turnOff()}show(){this.buttonElement.style.display="inline-block"}turnOff(){this.buttonElement.classList.remove("btn-active")}toggle(){return this.buttonElement.classList.contains("btn-active")?(this.buttonElement.classList.remove("btn-active"),!1):(this.buttonElement.classList.add("btn-active"),!0)}initializeOnClickHandler(e){this.buttonElement.addEventListener("click",e)}}}(QB||(QB={})),function(e){e.DocElemHelper=class{constructor(){}static getElementById(e){const t=document.getElementById(e);if(!t)throw new Error(`Failed to retrieve element with ID "${e}"`);return t}static getNextElemSibling(e){const t=e.nextElementSibling;if(!t)throw new Error('Element "'+e+'" unexpectedly had no siblings');return t}static newElemWithClass(e,t){const l=document.createElement(e);return l.className=t,l}static newElemWithText(e,t){const l=document.createElement(e);return l.innerText=t,l}}}(QB||(QB={})),function(e){e.Formatter=class{constructor(e,t,l){this.sqlTypeHandler=e,this.aliasFn=t,this.schema=l}formatTable(e,t=!1,l){const s=this.schema?`${this.schema}.${e}`:e;if(t){const t=l??this.aliasFn(e);if(t)return s+" "+t}return s}formatColumn(e,t,l,s){if(!l)return`<span class="sql-column">${t}</span>`;const n=s??this.aliasFn(e);return`${n||this.formatTable(e)}.<span class="sql-column">${t}</span>`}generateQuery(e){return e?this.produceSql(0,e)+";":""}produceSql(t,l){const s="    ".repeat(t),n="\n"+s,a=!!l.leftJoin;let r=s+'<span class="sql-keyword">SELECT</span> ';if(l.select?.length?(r+=l.select.map((e=>this.formatColumn(e.table,e.column,a,e.manualAlias))).join("\n     , "),l.aggregate&&(r+='\n     , <span class="sql-keyword">COUNT(<span class="sql-number">1</span>) AS <span class="sql-text">total</span></span>')):l.aggregate?r+='<span class="sql-keyword">COUNT(<span class="sql-number">1</span>) AS <span class="sql-text">total</span></span>':r+='<span class="sql-star">*</span>',r+=n+'<span class="sql-keyword">FROM</span> '+this.formatTable(l.table,a),l.leftJoin&&l.leftJoin.forEach((e=>{r+=n+'<span class="sql-keyword">LEFT JOIN</span> '+this.formatTable(e.targetTable,!0,e.targetTableAlias)+n+'  <span class="sql-keyword">ON</span> '+this.formatColumn(e.targetTable,e.targetColumn,!0,e.targetTableAlias)+" = "+this.formatColumn(e.sourceTable,e.sourceColumn,!0,e.sourceTableAlias),e.joinVariantFilter&&(r+=n+'    <span class="sql-keyword">AND</span> '+e.joinVariantFilter.replaceAll("$ALIAS",e.targetTableAlias))})),l.subqueryFilterColumn&&(r+=n+'<span class="sql-keyword">WHERE</span> '+this.formatColumn(l.table,l.subqueryFilterColumn,a)+' <span class="sql-keyword">IN</span> (\n'+this.produceSql(t+1,l.sub)+n+")"),l.where){const t=e.QueryState.inferOperatorForColumns(l.where);let s=!!l.subqueryFilterColumn;t.forEach((e=>{r+=s?n+'  <span class="sql-keyword">AND</span> ':n+'<span class="sql-keyword">WHERE</span> ';const t="OR"===e.operator?'    <span class="sql-keyword">OR</span> ':'   <span class="sql-keyword">AND</span> ',l=e.columnFilters.map((e=>{const t=this.formatColumn(e.table,e.column,a,e.tableAlias);return this.sqlTypeHandler.formatFilterForWhereClause(e,t)})).join(n+t);1===e.columnFilters.length?r+=l:r+="("+l+")",s=!0}))}return l.aggregate&&l.select?.length&&(r+=n+'<span class="sql-keyword">GROUP BY</span> '+l.select.map((e=>this.formatColumn(e.table,e.column,a))).join("\n       , ")),r}}}(QB||(QB={})),function(e){e.Initializer=class{__construct(){}static init(t,l,s,n,a,r,i){e.TableDefinitions.init(l);const o=new e.SqlTypeHandler(a),u=new e.Formatter(o,s,n),c=new e.QueryState,m=new e.AggregateButton(e.DocElemHelper.getElementById("btn_agg")),h=new e.QueryService(c,u,r,i),d=new e.SelectColumnMenu(h,o),p=new e.MenuHandler(e.DocElemHelper.getElementById("tables"),m,h,o,d);e.DocElemHelper.getElementById("btn_reset").addEventListener("click",(()=>p.showInitialTables())),m.initializeOnClickHandler((()=>{h.updateQuery((e=>{const t=m.toggle();e.setAggregate(t)}))}));const b=e.DocElemHelper.getElementById("copied_hint");e.DocElemHelper.getElementById("btn_copy").addEventListener("click",(()=>{navigator.clipboard.writeText(e.DocElemHelper.getElementById("query").innerText),b.classList.add("show"),setTimeout((()=>b.classList.remove("show")),800)})),p.showInitialTables(),e.DocElemHelper.getElementById("version").innerText=`v. ${t}`}}}(QB||(QB={})),function(e){class t{constructor(e,t,l,s,n){this.tablesContainer=e,this.aggregateButton=t,this.queryService=l,this.sqlTypeHandler=s,this.selectColumnMenu=n}showInitialTables(){this.aggregateButton.hide(),this.queryService.updateQuery((e=>{e.clearState()})),this.tablesContainer.innerHTML="<h3>Tables</h3>",this.tablesContainer.className="menu-initial";const t=e.DocElemHelper.newElemWithClass("div","table-list tl-initial");for(const l in e.TableDefinitions.getAllTables()){const s=document.createElement("button");s.className="btn-table"+this.getCustomClassSuffix(l),s.innerText=l,s.addEventListener("click",(()=>{const t=e.DocElemHelper.getNextElemSibling(s);"UL"===t.tagName?t.remove():this.showColumnsToFilterInitialTable(l,s)})),s.addEventListener("contextmenu",(e=>{e.preventDefault(),this.queryService.updateQuery((e=>{e.selectTable(l),this.showRelatedColumns(l),this.tablesContainer.append(this.selectColumnMenu.generateColumnsButtonOrList(!0))}))})),t.append(s),t.append(document.createElement("br"))}this.tablesContainer.append(t)}showColumnsToFilterInitialTable(t,l){for(const e of document.querySelectorAll("ul.columns"))e.remove();const s=e.DocElemHelper.newElemWithClass("ul","columns");for(const l in e.TableDefinitions.getColumns(t)){const n=e.DocElemHelper.newElemWithClass("li","clicky"),a=e.TableDefinitions.getStyle(t)[l]??"";n.innerHTML=`<span class="${a}">${l}</span>`,n.addEventListener("click",(()=>{this.selectColumnMenu.deleteAllWhereInputElements(),this.selectColumnMenu.createColumnFilterElem(n,(e=>{const s=this.sqlTypeHandler.validateColumnFilterElemOrAlertError(t,l,e);null!==s&&this.queryService.updateQuery((e=>{e.selectTableWithFilter(t,s),this.showRelatedColumns(t),this.tablesContainer.append(this.selectColumnMenu.generateColumnsButtonOrList(!0))}))}))})),n.addEventListener("contextmenu",(e=>{e.preventDefault(),this.queryService.updateQuery((e=>{e.selectTable(t),e.addColumnSelect(t,l),this.showRelatedColumns(t),this.tablesContainer.append(this.selectColumnMenu.generateColumnsButtonOrList())}))})),s.append(n)}l.after(s)}showFilterColumnsSubQuery(t){for(const e of document.querySelectorAll("ul.columns"))e.remove();const l=e.DocElemHelper.newElemWithText("h3",`Filter subquery (${t})`),s=e.DocElemHelper.newElemWithClass("ul","columns");for(const l in e.TableDefinitions.getColumns(t)){const n=e.DocElemHelper.newElemWithClass("li","clicky");n.innerText=l,n.addEventListener("click",(()=>{this.selectColumnMenu.deleteAllWhereInputElements(),this.selectColumnMenu.createColumnFilterElem(n,(e=>{const s=this.sqlTypeHandler.validateColumnFilterElemOrAlertError(t,l,e);null!==s&&this.queryService.updateQuery((e=>{e.addFilterToSubQuery(s),this.showRelatedColumns(e.getCurrentSelectedTable()),this.tablesContainer.append(this.selectColumnMenu.generateColumnsButtonOrList(!1))}))}))})),s.append(n)}this.tablesContainer.append(l),this.tablesContainer.append(s)}getClassForRelatedColumn(e,t){for(const t of this.queryService.getPastColumns())if(t.table===e)return"rc-past";return"rc-new"}collectRelatedColumns(t){const l=[];return e.TableDefinitions.collectAllReferences(t).forEach((e=>{l.push({...e,reversed:!1})})),e.TableDefinitions.collectReferencesToTable(t).forEach((e=>{l.push({sourceTable:e.targetTable,sourceColumn:e.targetColumn,targetTable:e.sourceTable,targetColumn:e.sourceColumn,joinVariants:e.joinVariants,reversed:!0})})),l}showRelatedColumns(t){const l=this.collectRelatedColumns(t);this.aggregateButton.show(),this.tablesContainer.innerHTML="<h3>Join/subquery table</h3>",this.tablesContainer.className="menu-related";const s=e.DocElemHelper.newElemWithClass("ul","table-list tl-related");l.forEach((l=>{const n=document.createElement("li"),a=e.DocElemHelper.newElemWithText("button","⟕");if(a.title="Left join",a.addEventListener("click",(()=>{const e={sourceTable:t,sourceColumn:l.sourceColumn,targetTable:l.targetTable,targetColumn:l.targetColumn};this.onClickLeftJoinColumn(e)})),n.append(a),this.queryService.showWhereQueryInButton()){const t=e.DocElemHelper.newElemWithText("button","⊆");t.title="keep current table, filter by this table",t.addEventListener("click",(()=>{this.onClickWhereIn(l.sourceColumn,l.targetTable,l.targetColumn)})),n.append(t)}const r=e.DocElemHelper.newElemWithClass("span","clicky"),i=this.getClassForRelatedColumn(l.targetTable,l.targetColumn)+this.getCustomClassSuffix(l.targetTable);r.innerHTML=` <span class="${i}">${l.targetTable}</span> (${l.targetColumn})`,n.append(r),r.addEventListener("click",(()=>{this.onClickReferenceColumn(l.sourceColumn,l.targetTable,l.targetColumn)})),r.addEventListener("contextmenu",(e=>{e.preventDefault(),this.onClickReferenceColumn(l.sourceColumn,l.targetTable,l.targetColumn)})),s.append(n)})),this.tablesContainer.append(s)}showLeftJoinColumns(){const t=this.queryService.collectTopLevelTables();this.aggregateButton.show();const l=[];t.forEach((e=>{l.push(...this.collectRelatedColumns(e))}));const s=[];for(const e of l)s.push(...this.mapTableReference(e,t));this.tablesContainer.innerHTML="<h3>Left join</h3>",this.tablesContainer.className="menu-left-join";const n=e.DocElemHelper.newElemWithClass("ul","table-list tl-left-join");s.forEach((t=>{const l=document.createElement("li"),s=e.DocElemHelper.newElemWithClass("span","clicky"),a="rc-target "+this.getClassForRelatedColumn(t.targetTable,t.targetColumn)+this.getCustomClassSuffix(t.targetTable),r="rc-source"+this.getCustomClassSuffix(t.sourceTable),i=t.sourceTableAlias?` (${t.sourceTableAlias})`:"",o=t.joinVariantName?` (${t.joinVariantName})`:"";s.innerHTML=` <span class="${r}">${t.sourceTable}</span>.${t.sourceColumn} ${i} &rarr; <span class="${a}">${t.targetTable}</span>.${t.targetColumn} ${o}`,l.append(s),s.addEventListener("click",(()=>{this.onClickLeftJoinColumn(t)})),s.addEventListener("contextmenu",(e=>{e.preventDefault(),this.onClickLeftJoinColumn(t)})),n.append(l)})),this.tablesContainer.append(n);const a=this.selectColumnMenu.generateColumnsButtonOrList();this.tablesContainer.append(a)}mapTableReference(e,l){const s=t.isNotNullAndNotEmpty(e.joinVariants)&&e.reversed,n=this.queryService.getLeftJoins();if(!s){if(l.has(e.sourceTable)&&l.has(e.targetTable))return[];const s=new Set,a=new Set;for(const t of n)t.sourceTable===e.sourceTable&&s.add(t.sourceTableAlias),t.targetTable===e.sourceTable&&s.add(t.targetTableAlias),t.sourceTable===e.targetTable&&a.add(t.sourceTableAlias),t.targetTable===e.targetTable&&a.add(t.targetTableAlias);t.addUndefinedIfEmpty(s),t.addUndefinedIfEmpty(a);const r=[];for(const t of s)for(const l of a)r.push({sourceTable:e.sourceTable,sourceColumn:e.sourceColumn,sourceTableAlias:t,targetTable:e.targetTable,targetColumn:e.targetColumn,targetTableAlias:l});return r}const a=new Set;if(n.filter((e=>!e.joinVariantName)).forEach((e=>{a.add(e.sourceTable),a.add(e.targetTable)})),a.has(e.sourceTable)&&a.has(e.targetTable))return[];const r=new Set;for(const t of n)t.sourceTable===e.sourceTable&&r.add(t.sourceTableAlias),t.targetTable===e.sourceTable&&r.add(t.targetTableAlias);t.addUndefinedIfEmpty(r);const i=[];return e.joinVariants.forEach((t=>{if(!n.some((l=>l.sourceTable===e.sourceTable&&l.targetTable===e.targetTable&&l.joinVariantName===t.name)))for(const l of r)i.push({sourceTable:e.sourceTable,sourceColumn:e.sourceColumn,sourceTableAlias:l,targetTable:e.targetTable,targetColumn:e.targetColumn,targetTableAlias:t.alias,joinVariantName:t.name,joinVariantFilter:t.filter})})),i}static isNotNullAndNotEmpty(e){return!!e&&e.length>0}static addUndefinedIfEmpty(e){0===e.size&&e.add(void 0)}onClickLeftJoinColumn(e){this.queryService.updateQuery((t=>{t.addLeftJoin(e),this.showLeftJoinColumns()}))}onClickReferenceColumn(e,t,l){this.queryService.updateQuery((s=>{s.addSuperQuery(e,t,l),this.aggregateButton.turnOff(),this.showRelatedColumns(t),this.tablesContainer.append(this.selectColumnMenu.generateColumnsButtonOrList(!0))}))}onClickWhereIn(e,t,l){this.queryService.updateQuery((s=>{s.addSubQuery(e,t,l),this.showRelatedColumns(s.getCurrentSelectedTable()),this.showFilterColumnsSubQuery(t),this.tablesContainer.append(this.selectColumnMenu.generateColumnsButtonOrList())}))}getCustomClassSuffix(t){const l=e.TableDefinitions.getStyle(t);return l.table?" "+l.table:""}}e.MenuHandler=t}(QB||(QB={})),function(e){e.QueryService=class{constructor(e,t,l,s){this.query=e,this.formatter=t,this.configDebugEnabled=l,this.configShowWhereInButton=s}updateQuery(e){e(this.query),this.updateQueryOnPage()}collectTopLevelTables(){return this.query.collectTopLevelTables()}collectSelectedTableAliasPairs(){const e=new Map;e.set(this.query.getCurrentSelectedTable(),new Set([void 0])),this.getLeftJoins().forEach((t=>{const l=e.get(t.sourceTable);void 0===l?e.set(t.sourceTable,new Set([t.sourceTableAlias])):l.add(t.sourceTableAlias);const s=e.get(t.targetTable);void 0===s?e.set(t.targetTable,new Set([t.targetTableAlias])):s.add(t.targetTableAlias)}));const t=[];for(let[l,s]of e)s.forEach((e=>{t.push({table:l,manualAlias:e})}));return t}getLeftJoins(){return this.query.getQuery()?.leftJoin??[]}showWhereQueryInButton(){return this.configShowWhereInButton&&!this.query.hasWhereInClause()}getPastColumns(){return this.query.getPastColumns()}hasColumnSelect(e,t,l){return this.query.hasColumnSelect(e,t,l)}hasAnyColumnSelect(){return this.query.hasAnyColumnSelect()}hasFilterOnColumn(e,t,l){const s=this.query.getQuery()?.where;return!!s&&s.some((s=>s.table===e&&s.column===t&&(!l&&!s.tableAlias||l===s.tableAlias)))}getFilters(e,t,l){const s=this.query.getQuery()?.where;return s?s.filter((s=>s.table===e&&s.column===t&&(!l&&!s.tableAlias||l===s.tableAlias))):[]}updateQueryOnPage(){const t=this.formatter.generateQuery(this.query.getQuery());e.DocElemHelper.getElementById("query").innerHTML=t,e.DocElemHelper.getElementById("btn_copy").style.display=t?"inline-block":"none",this.configDebugEnabled&&(e.DocElemHelper.getElementById("query_debug").innerHTML=JSON.stringify(this.query.getQuery()).replaceAll("{","{ "))}}}(QB||(QB={})),function(e){class t{constructor(){this.pastColumns=new Set}clearState(){this.query=void 0,this.pastColumns=new Set}selectTable(e){this.query={table:e},this.pastColumns.add({table:e,column:""})}selectTableWithFilter(e,t){this.query={table:e,where:[t]},this.pastColumns.add({table:e,column:t.column})}addFilter(e){if(!this.query)throw new Error("Expected query to be set");this.query.where||(this.query.where=[]),this.query.where.push(e)}addFilterToSubQuery(e){if(!this.query?.sub)throw new Error("Expect subquery to be set!");this.query.sub.where=this.query.sub.where??[],this.query.sub.where.push(e),this.pastColumns.add({table:this.query.sub.table,column:e.column})}addSuperQuery(e,t,l){if(!this.query)throw new Error("Query must be defined");this.query.select=[{table:this.query.table,column:e}],this.query.aggregate=!1,this.query={table:t,subqueryFilterColumn:l,sub:this.query},this.pastColumns.add({table:this.query.sub.table,column:e})}addSubQuery(e,t,l){if(!this.query)throw new Error("Query must be defined");this.query.subqueryFilterColumn=e,this.query.sub={select:[{column:l,table:t}],table:t},this.pastColumns.add({table:t,column:l})}addLeftJoin(e){this.query.leftJoin||(this.query.leftJoin=[]),this.query.leftJoin.push(e)}setAggregate(e){this.query.aggregate=e}clearColumnSelects(){this.query.select=[]}addColumnSelect(e,t,l){this.query.select||(this.query.select=[]),this.query.select.push({table:e,column:t,manualAlias:l})}removeFilter(e){if(!this.query?.where)throw new Error("Query has no filters");let t=!1;this.query.where=this.query.where.filter((l=>{if(t)return!0;const s=this.matches(e,l);return s&&(t=!0),!s}))}replaceFilter(e,t){if(!this.query?.where)throw new Error("Query has no filters");for(let l=0;l<this.query.where.length;++l)if(this.matches(e,this.query.where[l]))return void(this.query.where[l]=t);throw new Error("Could not replace filter")}matches(e,t){return e.table===t.table&&e.column===t.column&&(!e.tableAlias&&!t.tableAlias||e.tableAlias===t.tableAlias)&&e.type===t.type&&e.value===t.value}getCurrentSelectedTable(){return this.query.table}collectTopLevelTables(){const e=new Set;if(e.add(this.query.table),this.query.leftJoin)for(const t of this.query.leftJoin)e.add(t.sourceTable),e.add(t.targetTable);return e}hasWhereInClause(){return!!this.query?.subqueryFilterColumn}hasColumnSelect(e,t,l){return!(!this.query||!this.query.select)&&this.query.select.some((s=>s.table===e&&s.column===t&&s.manualAlias===l))}hasAnyColumnSelect(){return!!this.query?.select&&this.query.select.length>0}getQuery(){return this.query||null}getPastColumns(){return this.pastColumns}static inferOperatorForColumns(e){const l=t.groupFiltersByColumn(e),s=[];for(const e of l.values())if(1===e.length)s.push({operator:"AND",columnFilters:e});else{const t=this.determineOperator(e);s.push({operator:t,columnFilters:e})}return s}static determineOperator(e){return 1===e.length?"AND":e.find((e=>e.type===s.NULL_FILTER||e.type===s.PLAIN))?"OR":"AND"}static groupFiltersByColumn(e){const t=new Map;return e.forEach((e=>{const l=`${e.table}|${e.column}|`+(e.tableAlias??"");t.has(l)||t.set(l,[]),t.get(l).push(e)})),t}}e.QueryState=t;class l{constructor(e,t,l,s,n,a){this.table=e,this.column=t,this.type=l,this.value=s,this.inputValue=n,this.tableAlias=a}static plainFilter(e,t,n,a){return new l(e,t,s.PLAIN,n,void 0,a)}static nullFilter(e,t,n,a){return new l(e,t,s.NULL_FILTER,n,void 0,a)}}let s;e.ColumnFilter=l,function(e){e[e.PLAIN=0]="PLAIN",e[e.TIMESTAMP_INTERVAL=1]="TIMESTAMP_INTERVAL",e[e.TIMESTAMP_DATE_FILTER=2]="TIMESTAMP_DATE_FILTER",e[e.NULL_FILTER=3]="NULL_FILTER",e[e.NUMBER_COMPARISON=4]="NUMBER_COMPARISON"}(s=e.ColumnFilterType||(e.ColumnFilterType={}))}(QB||(QB={})),function(e){e.SelectColumnMenu=class{constructor(e,t){this.queryService=e,this.sqlTypeHandler=t,this.isExpanded=!1}generateColumnsButtonOrList(t){if(!this.isExpanded||t){this.isExpanded=!1;const t=e.DocElemHelper.newElemWithText("button","Select columns");return t.addEventListener("click",(()=>{this.isExpanded=!0,t.parentElement.append(this.createListElementWithSelectableColumns()),t.remove()})),t}return this.createListElementWithSelectableColumns()}createListElementWithSelectableColumns(){const t=this.queryService.collectSelectedTableAliasPairs(),l=[];t.forEach((t=>{for(const s in e.TableDefinitions.getColumns(t.table))l.push({table:t.table,column:s,manualAlias:t.manualAlias,active:this.queryService.hasColumnSelect(t.table,s,t.manualAlias)})}));const s=document.createElement("div"),n=e.DocElemHelper.newElemWithClass("h3","clicky");n.innerText="Select columns",n.addEventListener("click",(()=>{this.queryService.hasAnyColumnSelect()||(this.isExpanded=!1,s.parentElement.append(this.generateColumnsButtonOrList()),s.remove())}));const a=t.length>1,r=e.DocElemHelper.newElemWithClass("ul","column-select");let i="";return l.forEach((t=>{const l=document.createElement("li");i&&i!==t.table&&l.classList.add("separator");const s=e.TableDefinitions.getStyle(t.table);let o="";if(a){o=`<span class="tbl ${s.table??""}">${t.table}</span>.`}const u=e.DocElemHelper.newElemWithClass("button","filter");u.innerText="🜄",this.updateFilterButtonClasses(u,t.table,t.column,t.manualAlias),u.title="Edit filters",u.addEventListener("click",(()=>{const e=null!==l.querySelector("ul");this.deleteAllWhereInputElements(),e||this.createFiltersSublist(l,t.table,t.column,t.manualAlias)}));const c=e.DocElemHelper.newElemWithClass("span","clicky"),m=s[t.column]??"";c.innerHTML=o+`<span class="col ${m}">${t.column}</span>`+(t.manualAlias?` (${t.manualAlias})`:""),l.dataset.table=t.table,l.dataset.column=t.column,t.manualAlias&&(l.dataset.manualAlias=t.manualAlias),t.active&&l.classList.add("active-column"),l.append(u,document.createTextNode(" "),c),c.addEventListener("click",(()=>this.toggleColumnActive(l,n))),r.append(l),i=t.table})),s.append(n),s.append(r),s}toggleColumnActive(e,t){e.classList.contains("active-column")?e.classList.remove("active-column"):e.classList.add("active-column"),this.queryService.updateQuery((l=>{l.clearColumnSelects();for(const t of e.parentElement.children)if(t instanceof HTMLElement&&t.classList.contains("active-column")){const e=t.dataset.table,s=t.dataset.column,n=t.dataset.manualAlias;l.addColumnSelect(e,s,n)}this.queryService.hasAnyColumnSelect()?t.classList.remove("clicky"):t.classList.add("clicky")}))}deleteAllWhereInputElements(){for(const e of document.querySelectorAll(".where_input"))e.remove()}createColumnFilterElem(t,l){const s=e.DocElemHelper.newElemWithClass("input","where_input");s.type="text",s.addEventListener("keydown",(e=>{"Enter"===e.key&&l(s.value)})),t.after(s);const n=e.DocElemHelper.newElemWithClass("button","where_input");n.innerText="Add",n.addEventListener("click",(()=>{l(s.value)})),s.after(n)}createFiltersSublist(t,l,s,n){const a=e.DocElemHelper.newElemWithClass("ul","where_input");this.queryService.getFilters(l,s,n).forEach((r=>{const i=document.createElement("li"),o=document.createElement("input");o.type="text",o.value=r.inputValue??r.value;const u=e.DocElemHelper.newElemWithText("button","Save");u.addEventListener("click",(()=>{const e=this.sqlTypeHandler.validateColumnFilterElemOrAlertError(l,s,o.value,n);e&&(this.queryService.updateQuery((t=>{t.replaceFilter(r,e)})),this.updateFiltersListAfterAction(t,l,s,n))}));const c=e.DocElemHelper.newElemWithText("button","Del");c.addEventListener("click",(()=>{this.queryService.updateQuery((e=>{e.removeFilter(r)})),this.updateFiltersListAfterAction(t,l,s,n)})),r.type===e.ColumnFilterType.NULL_FILTER&&(o.disabled=!0,o.value=r.value?"NOT NULL":"NULL",u.disabled=!0),o.addEventListener("keydown",(e=>{"Enter"===e.key&&u.click()})),i.append(o,u,c),a.append(i)}));const r=document.createElement("li"),i=document.createElement("span");r.append(i),this.createColumnFilterElem(i,(e=>{const a=this.sqlTypeHandler.validateColumnFilterElemOrAlertError(l,s,e,n);null!==a&&(this.queryService.updateQuery((e=>{e.addFilter(a)})),this.updateFiltersListAfterAction(t,l,s,n))})),a.append(r),t.append(a)}updateFiltersListAfterAction(e,t,l,s){this.deleteAllWhereInputElements(),this.createFiltersSublist(e,t,l,s);const n=e.querySelector("button.filter");n&&this.updateFilterButtonClasses(n,t,l,s)}updateFilterButtonClasses(e,t,l,s){this.queryService.hasFilterOnColumn(t,l,s)?e.classList.add("filter-has-entries"):e.classList.remove("filter-has-entries")}}}(QB||(QB={})),function(e){e.SqlTypeHandler=class{constructor(e){this.dbEngine=e}formatFilterForWhereClause(t,l){switch(t.type){case e.ColumnFilterType.PLAIN:return l+" "+this.formatValueForWhereClause(t);case e.ColumnFilterType.NULL_FILTER:return l+" "+this.formatNullFilterForWhereClause(t);case e.ColumnFilterType.TIMESTAMP_INTERVAL:case e.ColumnFilterType.NUMBER_COMPARISON:return l+" "+t.value;case e.ColumnFilterType.TIMESTAMP_DATE_FILTER:return this.formatTimestampDateFilter(t,l);default:throw new Error("Unhandled filter type: "+t.type)}}formatValueForWhereClause(t){switch(e.TableDefinitions.getColumnType(t.table,t.column)){case"int":case"tinyint":case"decimal":case"number":return`= <span class="sql-number">${t.value}</span>`;default:return'= <span class="sql-text">\''+this.escapeValueForSqlAndHtml(t.value)+"'</span>"}}formatNullFilterForWhereClause(e){return e.value?'<span class="sql-keyword">IS NOT NULL</span>':'<span class="sql-keyword">IS NULL</span>'}validateColumnFilterElemOrAlertError(e,t,l,s){try{return this.validateColumnFilterElem(e,t,l,s)}catch(e){return window.alert(e.message),null}}validateColumnFilterElem(t,l,s,n){if(""===s||"!"===s)return e.ColumnFilter.nullFilter(t,l,s,n);let a=e.TableDefinitions.getColumnType(t,l);switch(a.startsWith("timestamp")&&(a="timestamp"),a){case"int":case"tinyint":case"decimal":case"number":return this.handleNumberFilter(t,l,s,n);case"timestamp":case"datetime":return this.handleDateTimeValue(t,l,s);case"varchar":case"varchar2":case"blob":case"clob":return e.ColumnFilter.plainFilter(t,l,s,n);default:return console.log(`Unhandled validation for ${a}`),e.ColumnFilter.plainFilter(t,l,s,n)}}handleDateTimeValue(t,l,s,n){const a=s.trim().match(/^(>|>=|=|<=|<|<>)?\s*([+\-])?\s*(\d+)\s*([smhdy])$/);if(a){const r=a[2]??"+",i=this.escapeValueForSqlAndHtml(a[1]??("+"===r?"<":">")),o=a[3],u=this.convertDateTimeUnit(a[4]),c="MySQL"===this.dbEngine?`${i} NOW() ${r} <span class="sql-keyword">INTERVAL</span> <span class="sql-number">${o}</span> <span class="sql-keyword">${u}</span>`:`${i} sysdate ${r} <span class="sql-keyword">INTERVAL</span> '<span class="sql-number">${o}</span>' <span class="sql-keyword">${u}</span>`;return new e.ColumnFilter(t,l,e.ColumnFilterType.TIMESTAMP_INTERVAL,c,s,n)}const r=s.trim().match(/^(>|>=|=|<=|<|<>)?\s*(\d{4}-\d{2}-\d{2})$/);if(r){const a=r[1]??"=",i=r[2],o="MySQL"===this.dbEngine?`'<span class='sql-text'>${i}</span>'`:`<span class="sql-keyword">TO_DATE</span>('<span class="sql-text">${i}</span>', '<span class="sql-text">YYYY-MM-DD</span>')`;return new e.ColumnFilter(t,l,e.ColumnFilterType.TIMESTAMP_DATE_FILTER,a+" "+o,s,n)}throw Error("Invalid timestamp expression")}formatTimestampDateFilter(e,t){return`<span class="sql-keyword">${"MySQL"===this.dbEngine?"DATE":"TRUNC"}</span>(${t}) ${e.value}`}handleNumberFilter(t,l,s,n){const a=s.trim().match(/^(>|>=|=|<=|<|<>)\s*(-?(\d+)(\.\d+)?)$/);if(a){const r=`${this.escapeValueForSqlAndHtml(a[1])} <span class="sql-number">${a[2]}</span>`;return new e.ColumnFilter(t,l,e.ColumnFilterType.NUMBER_COMPARISON,r,s,n)}if(Number.isNaN(Number(s)))throw new Error("Invalid number");return e.ColumnFilter.plainFilter(t,l,s,n)}convertDateTimeUnit(e){switch(e){case"s":return"SECOND";case"m":return"MINUTE";case"h":return"HOUR";case"d":return"DAY";case"y":return"YEAR";default:throw new Error(`Unhandled unit: ${e}`)}}escapeValueForSqlAndHtml(e){return e.replaceAll("'","''").replaceAll("&","&amp;").replaceAll("<","&lt;")}}}(QB||(QB={})),function(e){e.TableDefinitions=class{constructor(){}static init(e){this.tables=e}static getColumnType(e,t){return this.tables[e].columns[t]}static getColumns(e){return this.tables[e].columns}static collectAllReferences(e){const t=[];return Object.entries(this.tables[e].references).forEach((([l,s])=>{s.forEach((s=>{t.push({sourceTable:e,sourceColumn:l,targetTable:s.table,targetColumn:s.column,joinVariants:s.joinVariants})}))})),t}static collectReferencesToTable(e){const t=[];for(const l in this.tables)l!==e&&Object.entries(this.tables[l].references).forEach((([s,n])=>{n.forEach((n=>{n.table===e&&t.push({sourceTable:l,sourceColumn:s,targetTable:e,targetColumn:n.column,joinVariants:n.joinVariants})}))}));return t}static getAllTables(){return this.tables}static getStyle(e){return this.tables[e].style??{}}}}(QB||(QB={}));
</script>
<script>

// -------------
// Configuration
// -------------

const __dbEngine = 'MySQL'; // MySQL or Oracle
const __schema = 'nightbot_quiz';
const __aliasFn = function (tableName) {
    return __tables[tableName].alias;
};

// Show internal query object as JSON
const __debug = false;

// Show the '⊆' button that *adds* a subquery to the current table. If you feel that there are too many buttons,
// you can hide this to simplify the UI. Clicking on a table name will take the current query and use it as subquery,
// which is possible in more situations than this button.
const __showWhereInButton = true;

// -------------
// End config
// -------------

const __version = '20250407';
QB.Initializer.init(__version, __tables, __aliasFn, __schema, __dbEngine, __debug, __showWhereInButton);

</script>
</body>
</html>