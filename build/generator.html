<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Query generator</title>
    <script src="tables.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            font-size: 11pt;
        }

        /* rc = related column */
        .rc-prev {
            color: #ccc;
        }
        .rc-past {
            color: #666;
        }
        .rc-new {
            font-weight: bold;
        }

        .sql-keyword {
            color: #620;
            font-weight: bold;
        }
        .sql-star {
            color: #f50;
        }
        .sql-column {
            color: #a01;
        }
        .sql-text {
            color: #250;
        }
        .sql-number {
            color: #30f;
        }

        #page {
            display: flex;
            height: 100vh; /* Full height of the viewport */
        }
        #side {
            flex-shrink: 0;
            height: 100vh;
            min-width: 470px;
            overflow-y: auto;
            padding: 8px;
        }
        #result {
            flex-grow: 1;
            padding: 20px;
            font-family: Consolas, monospace;
        }
        #query {
            border: 1px solid #333;
            background-color: #eee;
            display: inline-block;
            padding: 20px;
        }
        #query:empty, #query_debug:empty {
            display: none;
        }
        #tables {
            margin-bottom: 1em;
        }
        #version {
            float: right;
            font-size: 0.8em;
            color: #ac8;
        }
        .clicky {
            cursor: pointer;
        }
        .active-column {
            font-weight: bold;
        }
        .btn-active {
            background-color: #ff4;
        }
        .btn-table {
            background-color: transparent;
            color: #222;
            font-weight: bold;
            padding: 2px;
            border: 0;
            font-size: 10.5pt;
        }
        .btn-table:hover {
            background-color: #ff7;
        }
        ul.table-list {
            list-style: none;
            padding: 5px;
        }
    </style>
</head>
<body>

<div id="version"></div>
<div id="page">
    <div id="side">
        <div id="tables"></div>
        <button id="btn_reset">Reset</button>
        <button id="btn_agg" style="display: none">Aggregate</button>
    </div>
    <div id="result">
        <pre id="query"></pre>
        <div id="query_debug"></div>
    </div>
</div>

<script>
"use strict";var QB;!function(e){e.AggregateButton=class{constructor(e){this.buttonElement=e}hide(){this.buttonElement.style.display="none",this.turnOff()}show(){this.buttonElement.style.display="inline-block"}turnOff(){this.buttonElement.classList.remove("btn-active")}toggle(){return this.buttonElement.classList.contains("btn-active")?(this.buttonElement.classList.remove("btn-active"),!1):(this.buttonElement.classList.add("btn-active"),!0)}initializeOnClickHandler(e){this.buttonElement.addEventListener("click",e)}}}(QB||(QB={})),function(e){e.DocElemHelper=class{constructor(){}static getElementById(e){const t=document.getElementById(e);if(!t)throw new Error(`Failed to retrieve element with ID "${e}"`);return t}static getNextElemSibling(e){const t=e.nextElementSibling;if(!t)throw new Error('Element "'+e+'" unexpectedly had no siblings');return t}static newElemWithClass(e,t){const l=document.createElement(e);return l.classList.add(t),l}static newElemWithText(e,t){const l=document.createElement(e);return l.innerText=t,l}}}(QB||(QB={})),function(e){e.Formatter=class{constructor(e,t,l){this.sqlTypeHandler=e,this.aliasFn=t,this.schema=l}formatTable(e,t=!1){const l=this.schema?`${this.schema}.${e}`:e;if(t){const t=this.aliasFn(e);if(t)return l+" "+t}return l}formatColumn(e,t,l=!1){if(!l)return`<span class="sql-column">${t}</span>`;const s=this.aliasFn(e);return`${s||this.formatTable(e)}.<span class="sql-column">${t}</span>`}generateQuery(e){return e?this.produceSql(0,e)+";":""}produceSql(e,t){const l="    ".repeat(e),s="\n"+l,n=!!t.leftJoin;let a=l+'<span class="sql-keyword">SELECT</span> ';return t.select?.length?(a+=t.select.map((e=>this.formatColumn(e.table,e.column,n))).join("\n     , "),t.aggregate&&(a+='\n     , <span class="sql-keyword">COUNT(<span class="sql-number">1</span>) AS <span class="sql-text">total</span></span>')):t.aggregate?a+='<span class="sql-keyword">COUNT(<span class="sql-number">1</span>) AS <span class="sql-text">total</span></span>':a+='<span class="sql-star">*</span>',a+=s+'<span class="sql-keyword">FROM</span> '+this.formatTable(t.table,n),t.leftJoin&&t.leftJoin.forEach((e=>{a+=s+'<span class="sql-keyword">LEFT JOIN</span> '+this.formatTable(e.targetTable,!0)+s+'  <span class="sql-keyword">ON</span> '+this.formatColumn(e.targetTable,e.targetColumn,!0)+" = "+this.formatColumn(e.sourceTable,e.sourceColumn,!0)})),t.subqueryFilterColumn&&(a+=s+'<span class="sql-keyword">WHERE</span> '+this.formatColumn(t.table,t.subqueryFilterColumn,n)+' <span class="sql-keyword">IN</span> (\n'+this.produceSql(e+1,t.sub)+s+")"),t.where&&(t.subqueryFilterColumn?a+=s+'  <span class="sql-keyword">AND</span> ':a+=s+'<span class="sql-keyword">WHERE</span> ',a+=this.formatColumn(t.table,t.where.column,n),t.where.filter?"!"===t.where.filter?a+=' <span class="sql-keyword">IS NOT NULL</span>':a+=" = "+this.sqlTypeHandler.formatValueForWhereClause(t.where.filter,t.table,t.where.column):a+=' <span class="sql-keyword">IS NULL</span>'),t.aggregate&&t.select?.length&&(a+=s+'<span class="sql-keyword">GROUP BY</span> '+t.select.map((e=>this.formatColumn(e.table,e.column,n))).join("\n       , ")),a}}}(QB||(QB={})),function(e){e.MenuHandler=class{constructor(e,t,l,s,n){this.tablesContainer=e,this.aggregateButton=t,this.queryService=l,this.sqlTypeHandler=s,this.selectColumnMenu=n}showInitialTables(){this.aggregateButton.hide(),this.queryService.updateQuery((e=>{e.clearState()})),this.tablesContainer.innerHTML="<h3>Tables</h3>";for(const t in e.TableDefinitions.getAllTables()){const l=e.DocElemHelper.newElemWithClass("button","btn-table");l.innerText=t,l.addEventListener("click",(()=>{const s=e.DocElemHelper.getNextElemSibling(l);"UL"===s.tagName?s.remove():this.showColumnsToFilterInitialTable(t,l)})),l.addEventListener("contextmenu",(e=>{e.preventDefault(),this.queryService.updateQuery((e=>{e.selectTable(t),this.showRelatedColumns(t),this.tablesContainer.append(this.selectColumnMenu.generateColumnsButtonOrList(!0))}))})),this.tablesContainer.appendChild(l),this.tablesContainer.appendChild(document.createElement("br"))}}showColumnsToFilterInitialTable(t,l){for(const e of document.querySelectorAll("ul.columns"))e.remove();const s=e.DocElemHelper.newElemWithClass("ul","columns");for(const l in e.TableDefinitions.getColumns(t)){const n=e.DocElemHelper.newElemWithClass("li","clicky");n.innerText=l,n.addEventListener("click",(()=>this.createColumnFilterElem(t,l,n,!1))),s.appendChild(n)}l.after(s)}showFilterColumnsSubQuery(t){for(const e of document.querySelectorAll("ul.columns"))e.remove();const l=e.DocElemHelper.newElemWithText("h3",`Filter subquery (${t})`),s=e.DocElemHelper.newElemWithClass("ul","columns");for(const l in e.TableDefinitions.getColumns(t)){const n=e.DocElemHelper.newElemWithClass("li","clicky");n.innerText=l,n.addEventListener("click",(()=>{this.createColumnFilterElem(t,l,n,!0)})),s.appendChild(n)}this.tablesContainer.append(l),this.tablesContainer.append(s)}createColumnFilterElem(t,l,s,n){for(const e of document.querySelectorAll(".where_input"))e.remove();const a=e.DocElemHelper.newElemWithClass("input","where_input");a.type="text";const r=()=>{try{this.sqlTypeHandler.validateColumnFilterElem(t,l,a.value)}catch(e){return void window.alert(e.message)}this.queryService.updateQuery((e=>{n?e.addFilterToSubQuery(l,a.value):e.selectTableWithFilter(t,l,a.value),this.showRelatedColumns(n?e.getCurrentSelectedTable():t),this.tablesContainer.append(this.selectColumnMenu.generateColumnsButtonOrList(!n))}))};a.addEventListener("keydown",(e=>{"Enter"===e.key&&r()})),s.after(a);const o=e.DocElemHelper.newElemWithClass("button","where_input");o.innerText="Go",o.addEventListener("click",(()=>{r()})),a.after(o)}getClassForRelatedColumn(e,t){for(const t of this.queryService.getPastColumns())if(t.table===e)return"rc-past";return"rc-new"}collectRelatedColumns(t){const l=[];return e.TableDefinitions.collectAllReferences(t).forEach((e=>{l.push(e)})),e.TableDefinitions.collectReferencesToTable(t).forEach((e=>{l.push({sourceTable:e.targetTable,sourceColumn:e.targetColumn,targetTable:e.sourceTable,targetColumn:e.sourceColumn})})),l}showRelatedColumns(t){const l=this.collectRelatedColumns(t);this.aggregateButton.show(),this.tablesContainer.innerHTML="<h3>Join/subquery table</h3>";const s=e.DocElemHelper.newElemWithClass("ul","table-list");this.tablesContainer.append(s),l.forEach((l=>{const n=document.createElement("li");if(this.queryService.showWhereQueryInButton()){const t=e.DocElemHelper.newElemWithText("button","⊆");t.title="keep current table, filter by this table",t.addEventListener("click",(()=>{this.onClickWhereIn(l.sourceColumn,l.targetTable,l.targetColumn)})),n.append(t)}const a=e.DocElemHelper.newElemWithText("button","⟕");a.title="Left join",a.addEventListener("click",(()=>{this.onClickLeftJoinColumn(t,l.sourceColumn,l.targetTable,l.targetColumn)})),n.append(a);const r=e.DocElemHelper.newElemWithClass("span","clicky"),o=this.getClassForRelatedColumn(l.targetTable,l.targetColumn);r.innerHTML=` <span class="${o}">${l.targetTable}</span> (${l.targetColumn})`,n.append(r),r.addEventListener("click",(()=>{this.onClickReferenceColumn(l.sourceColumn,l.targetTable,l.targetColumn)})),r.addEventListener("contextmenu",(e=>{e.preventDefault(),this.onClickReferenceColumn(l.sourceColumn,l.targetTable,l.targetColumn)})),s.appendChild(n)}))}showLeftJoinColumns(){const t=this.queryService.collectTopLevelTables();this.aggregateButton.show();let l=[];t.forEach((e=>{l.push(...this.collectRelatedColumns(e))})),l=l.filter((e=>!t.has(e.sourceTable)||!t.has(e.targetTable))),this.tablesContainer.innerHTML="<h3>Left join</h3>";const s=e.DocElemHelper.newElemWithClass("ul","table-list");this.tablesContainer.append(s),l.forEach((t=>{const l=document.createElement("li"),n=e.DocElemHelper.newElemWithClass("span","clicky"),a=this.getClassForRelatedColumn(t.targetTable,t.targetColumn);n.innerHTML=` <b>${t.sourceTable}</b>.${t.sourceColumn} &rarr; <span class="${a}">${t.targetTable}</span>.${t.targetColumn} `,l.append(n),n.addEventListener("click",(()=>{this.onClickLeftJoinColumn(t.sourceTable,t.sourceColumn,t.targetTable,t.targetColumn)})),n.addEventListener("contextmenu",(e=>{e.preventDefault(),this.onClickLeftJoinColumn(t.sourceTable,t.sourceColumn,t.targetTable,t.targetColumn)})),s.appendChild(l)}));const n=this.selectColumnMenu.generateColumnsButtonOrList();this.tablesContainer.append(n)}onClickLeftJoinColumn(e,t,l,s){this.queryService.updateQuery((n=>{n.addLeftJoin(e,t,l,s),this.showLeftJoinColumns()}))}onClickReferenceColumn(e,t,l){this.queryService.updateQuery((s=>{s.addSuperQuery(e,t,l),this.aggregateButton.turnOff(),this.showRelatedColumns(t),this.tablesContainer.append(this.selectColumnMenu.generateColumnsButtonOrList(!0))}))}onClickWhereIn(e,t,l){this.queryService.updateQuery((s=>{s.addSubQuery(e,t,l),this.showRelatedColumns(s.getCurrentSelectedTable()),this.showFilterColumnsSubQuery(t),this.tablesContainer.append(this.selectColumnMenu.generateColumnsButtonOrList())}))}}}(QB||(QB={})),function(e){e.QueryService=class{constructor(e,t,l,s){this.query=e,this.formatter=t,this.configDebugEnabled=l,this.configShowWhereInButton=s}updateQuery(e){e(this.query),this.updateQueryOnPage()}collectTopLevelTables(){return this.query.collectTopLevelTables()}showWhereQueryInButton(){return this.configShowWhereInButton&&!this.query.hasWhereInClause()}getPastColumns(){return this.query.getPastColumns()}hasColumnSelect(e,t){return this.query.hasColumnSelect(e,t)}updateQueryOnPage(){e.DocElemHelper.getElementById("query").innerHTML=this.formatter.generateQuery(this.query.getQuery()),this.configDebugEnabled&&(e.DocElemHelper.getElementById("query_debug").innerHTML=JSON.stringify(this.query.getQuery()).replaceAll("{","{ "))}}}(QB||(QB={})),function(e){e.QueryState=class{constructor(){this.pastColumns=new Set}clearState(){this.query=void 0,this.pastColumns=new Set}selectTable(e){this.query={table:e},this.pastColumns.add({table:e,column:""})}selectTableWithFilter(e,t,l){this.query={table:e,where:{column:t,filter:l}},this.pastColumns.add({table:e,column:t})}addFilterToSubQuery(e,t){if(!this.query?.sub)throw new Error("Expect subquery to be set!");this.query.sub.where={column:e,filter:t},this.pastColumns.add({table:this.query.sub.table,column:e})}addSuperQuery(e,t,l){if(!this.query)throw new Error("Query must be defined");this.query.select=[{table:this.query.table,column:e}],this.query.aggregate=!1,this.query={table:t,subqueryFilterColumn:l,sub:this.query},this.pastColumns.add({table:this.query.sub.table,column:e})}addSubQuery(e,t,l){if(!this.query)throw new Error("Query must be defined");this.query.subqueryFilterColumn=e,this.query.sub={select:[{column:l,table:t}],table:t},this.pastColumns.add({table:t,column:l})}addLeftJoin(e,t,l,s){this.query.leftJoin||(this.query.leftJoin=[]),this.query.leftJoin.push({sourceTable:e,sourceColumn:t,targetTable:l,targetColumn:s})}setAggregate(e){this.query.aggregate=e}clearColumnSelects(){this.query.select=[]}addColumnSelect(e,t){this.query.select||(this.query.select=[]),this.query.select.push({table:e,column:t})}getCurrentSelectedTable(){return this.query.table}collectTopLevelTables(){const e=new Set;if(e.add(this.query.table),this.query.leftJoin)for(const t of this.query.leftJoin)e.add(t.sourceTable),e.add(t.targetTable);return e}hasWhereInClause(){return!!this.query?.subqueryFilterColumn}hasColumnSelect(e,t){return!(!this.query||!this.query.select)&&this.query.select.some((l=>l.table===e&&l.column===t))}getQuery(){return this.query||null}getPastColumns(){return this.pastColumns}}}(QB||(QB={})),function(e){e.SelectColumnMenu=class{constructor(e){this.queryService=e,this.isExpanded=!1}generateColumnsButtonOrList(t){if(!this.isExpanded||t){this.isExpanded=!1;const t=e.DocElemHelper.newElemWithText("button","Select columns");return t.addEventListener("click",(()=>{this.isExpanded=!0,t.parentElement.append(this.createListElementWithSelectableColumns()),t.remove()})),t}return this.createListElementWithSelectableColumns()}createListElementWithSelectableColumns(){const t=this.queryService.collectTopLevelTables(),l=[];t.forEach((t=>{for(const s in e.TableDefinitions.getColumns(t))l.push({table:t,column:s,active:this.queryService.hasColumnSelect(t,s)})}));const s=e.DocElemHelper.newElemWithText("h3","Select columns"),n=document.createElement("ul");l.forEach((t=>{const l=e.DocElemHelper.newElemWithClass("li","clicky");l.innerText=t.table+"."+t.column,l.dataset.table=t.table,l.dataset.column=t.column,t.active&&l.classList.add("active-column"),l.addEventListener("click",(()=>{l.classList.contains("active-column")?l.classList.remove("active-column"):l.classList.add("active-column"),this.queryService.updateQuery((e=>{e.clearColumnSelects();for(const t of n.children)if(t instanceof HTMLElement&&t.classList.contains("active-column")){const l=t.dataset.table,s=t.dataset.column;e.addColumnSelect(l,s)}}))})),n.append(l)}));const a=document.createElement("div");return a.append(s),a.append(n),a}}}(QB||(QB={})),function(e){e.SqlTypeHandler=class{formatValueForWhereClause(t,l,s){switch(e.TableDefinitions.getColumnType(l,s)){case"int":case"tinyint":case"decimal":case"number":return`<span class="sql-number">${t}</span>`;default:return'<span class="sql-text">\''+this.escapeValueForSqlAndHtml(t)+"'</span>"}}validateColumnFilterElem(t,l,s){let n=e.TableDefinitions.getColumnType(t,l);switch(n.startsWith("timestamp")&&(n="timestamp"),n){case"int":case"tinyint":case"decimal":case"number":if(s&&"!"!==s&&Number.isNaN(Number(s)))throw new Error("Invalid number");break;case"varchar":case"varchar2":case"timestamp":case"datetime":case"blob":case"clob":break;default:console.log(`Unhandled validation for ${n}`)}}escapeValueForSqlAndHtml(e){return e.replaceAll("'","''").replaceAll("&","&amp;").replaceAll("<","&lt;")}}}(QB||(QB={})),function(e){e.TableDefinitions=class{constructor(){}static init(e){this.tables=e}static getColumnType(e,t){return this.tables[e].columns[t]}static getColumns(e){return this.tables[e].columns}static collectAllReferences(e){const t=[];return Object.entries(this.tables[e].references).forEach((([l,s])=>{s.forEach((s=>{t.push({sourceTable:e,sourceColumn:l,targetTable:s.table,targetColumn:s.column})}))})),t}static collectReferencesToTable(e){const t=[];for(const l in this.tables)l!==e&&Object.entries(this.tables[l].references).forEach((([s,n])=>{n.forEach((n=>{n.table===e&&t.push({sourceTable:l,sourceColumn:s,targetTable:e,targetColumn:n.column})}))}));return t}static getAllTables(){return this.tables}}}(QB||(QB={}));
</script>
<script>

// -------------
// Configuration
// -------------

const __schema = 'nightbot_quiz';
const __aliasFn = function (tableName) {
    return __tables[tableName].alias;
};

// Show internal query object as JSON
const __debug = false;

// Show the '⊆' button that ADDS a subquery to the current table. Can be hidden if there are too many buttons,
// as clicking on a table will take the current query as subquery, which is possible in more situations than
// the '⊆' button. Hide to simplify the UI.
const __showWhereInButton = true;

// -------------
// End config
// -------------
const __version = '20241222';

QB.TableDefinitions.init(__tables);
const m_sqlTypeHandler = new QB.SqlTypeHandler();
const m_formatter = new QB.Formatter(m_sqlTypeHandler, __aliasFn, __schema);
const m_query = new QB.QueryState();
const m_aggregateButton = new QB.AggregateButton(QB.DocElemHelper.getElementById('btn_agg'));
const m_queryService = new QB.QueryService(m_query, m_formatter, __debug, __showWhereInButton);
const m_selectColumnMenu = new QB.SelectColumnMenu(m_queryService);
const m_menuHandler = new QB.MenuHandler(QB.DocElemHelper.getElementById('tables'),
    m_aggregateButton, m_queryService, m_sqlTypeHandler, m_selectColumnMenu);

function onClickAggregateButton() {
    m_queryService.updateQuery(query => {
        const newValue = m_aggregateButton.toggle();
        query.setAggregate(newValue);
    });
}

// Set up button onclick behavior
document.getElementById('btn_reset').addEventListener('click', () => m_menuHandler.showInitialTables());
m_aggregateButton.initializeOnClickHandler(() => onClickAggregateButton());

// Initialization
m_menuHandler.showInitialTables();
const versionElem = document.getElementById('version');
versionElem.innerText = `v. ${__version}`;
</script>
</body>
</html>